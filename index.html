<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•°ä¸–ç•Œäººç”Ÿæ¨¡æ“¬å™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©æ¨£å¼ */
        .game-container {
            height: 75vh;
            min-height: 600px;
        }
        .chat-area {
            height: 100%;
        }
        .chat-bubble {
            max-width: 95%;
            padding: 10px 15px;
            border-radius: 16px;
            margin-bottom: 8px;
        }
        .user-bubble {
            background-color: #4f46e5; /* é›è—è‰² */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-bubble {
            background-color: #d1d5db; /* æ·ºç°è‰² */
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .context-panel {
            background-color: #f3f4f6;
            border-left: 4px solid #4f46e5;
        }
        /* éŠæˆ²çµæŸç–Šå±¤ */
        .game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            border-radius: 0.75rem;
            flex-direction: column;
            padding: 40px;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen flex items-center justify-center p-6 font-sans">
    <div id="app" class="bg-white shadow-2xl rounded-xl w-full max-w-7xl flex flex-col p-8 space-y-6 relative">
        <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-4 border-b pb-2">ğŸŒŒ ç•°ä¸–ç•Œäººç”Ÿæ¨¡æ“¬å™¨</h1>
        
        <!-- éšæ®µå®¹å™¨ -->
        <div id="stage-container" class="flex flex-col space-y-6">
            
            <!-- éšæ®µ 1: API Key è¼¸å…¥ -->
            <div id="stage-api-key" class="stage space-y-4 p-4 border rounded-lg shadow-md bg-white">
                <h2 class="text-xl font-semibold text-gray-700">æ­¥é©Ÿ 1: è¼¸å…¥ API Key</h2>
                <div class="flex space-x-4">
                    <select id="api-type-select" 
                            class="p-3 border border-gray-300 rounded-lg shadow-inner bg-white">
                        <option value="gemini">Gemini API Key</option>
                        <option value="gpt">GPT (OpenAI) API Key</option>
                    </select>
                    <input type="password" id="api-key-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„ API Key" 
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="handleApiKeyInput()" 
                        class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-lg">
                    ç¢ºèªé‡‘é‘°ä¸¦ç¹¼çºŒ
                </button>
            </div>

            <!-- éšæ®µ 2: è§’è‰²å‰µå»º -->
            <div id="stage-create-char" class="stage hidden space-y-4 p-4 border rounded-lg shadow-md bg-white">
                <h2 class="text-xl font-semibold text-gray-700">æ­¥é©Ÿ 2: å‰µå»ºä½ çš„ç•°ä¸–ç•Œè§’è‰²</h2>
                <div class="space-y-3">
                    <input type="text" id="player-name-input" placeholder="è§’è‰²åç¨± (ä¾‹å¦‚: è‰¾ç‘å…‹)" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <textarea id="player-bio-input" rows="3" placeholder="ä½ çš„å‡ºèº«èƒŒæ™¯èˆ‡èƒ½åŠ› (ä¾‹å¦‚: å¤ä»£å¸åœ‹ä¸­æ¸´æœ›å­¸ç¿’é­”æ³•çš„è¾²æ°‘ï¼Œé‡‘éŒ¢ 100ï¼Œç”Ÿå‘½å€¼ 100)"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                    <input type="text" id="player-goal-input" placeholder="ä½ çš„ä¸»è¦äººç”Ÿç›®æ¨™ (ä¾‹å¦‚: å°‹æ‰¾å‚³èªªä¸­çš„å¤±è½é­”æ³•æ›¸)" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="handleCharCreation()" 
                        class="w-full bg-indigo-600 text-white p-3 rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-lg">
                    å•Ÿå‹•ä¸–ç•Œæ¨¡æ“¬
                </button>
            </div>

            <!-- éšæ®µ 3: éŠæˆ²ä¸»ä»‹é¢ -->
            <div id="stage-game" class="stage hidden game-container flex space-x-4">
                
                <!-- å·¦å´ï¼šé•·æœŸè¨˜æ†¶ (ä¸–ç•Œç´€éŒ„) -->
                <div class="w-1/3 p-4 rounded-xl context-panel overflow-y-auto">
                    <h3 class="text-lg font-bold text-indigo-700 mb-3 border-b pb-2">ğŸ“ ä¸–ç•Œç´€éŒ„ (é•·æœŸè¨˜æ†¶)</h3>
                    <!-- æ™‚é–“é¡¯ç¤º -->
                    <div class="text-center text-lg font-bold text-gray-700 p-2 border rounded-lg bg-yellow-100 mb-4">
                        å‰©é¤˜æ™‚é–“: <span id="time-display">--:--</span>
                    </div>

                    <div class="space-y-4 text-sm text-gray-700">
                        <div>
                            <p class="font-semibold text-gray-800">ç©å®¶ç‹€æ…‹:</p>
                            <pre id="context-bio" class="whitespace-pre-wrap text-xs bg-white p-2 rounded border"></pre>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">ç•¶å‰ç›®æ¨™:</p>
                            <p id="context-goal" class="text-xs italic"></p>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">æ­·å²äº‹ä»¶ (å› æœ):</p>
                            <pre id="context-events" class="whitespace-pre-wrap text-xs bg-white p-2 rounded border"></pre>
                        </div>
                    </div>
                </div>

                <!-- å³å´ï¼šéŠæˆ²/èŠå¤©å€ -->
                <div class="w-2/3 flex flex-col space-y-4">
                    <div id="chat-interface" class="chat-area p-4 rounded-xl bg-gray-100 flex flex-col overflow-y-auto space-y-2">
                        <!-- AI å’Œç©å®¶çš„å°è©±å°‡åœ¨é€™è£¡ -->
                    </div>
                    
                    <!-- è¼¸å…¥æ¡† -->
                    <div class="flex space-x-2">
                        <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„è¡Œå‹• (ä¾‹å¦‚: è©¢å•æ‘é•·é—œæ–¼é­”æ³•çš„äº‹)" 
                               class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-200">
                        <button id="send-btn" onclick="sendMessage()" 
                                class="p-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition duration-200 shadow-md disabled:bg-gray-400">
                            è¡Œå‹•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- éŠæˆ²çµæŸç–Šå±¤ (é è¨­éš±è—) -->
        <div id="game-over-overlay" class="game-over-overlay hidden p-10">
            <h2 class="text-5xl font-extrabold text-red-500">GAME OVER</h2>
            <p id="game-over-message" class="text-2xl font-semibold text-white mt-4 mb-8"></p>
            <button onclick="window.location.reload()"
                    class="p-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition duration-200 shadow-lg w-64">
                é‡æ–°é–‹å§‹ç•°ä¸–ç•Œäººç”Ÿ
            </button>
        </div>

        <!-- éŒ¯èª¤å’Œæç¤ºè¨Šæ¯ -->
        <p id="message-box" class="text-red-500 text-center hidden mt-4"></p>
        <div id="loading-indicator" class="text-center text-gray-600 hidden mt-4 flex items-center justify-center">
            <svg class="animate-spin h-5 w-5 mr-3 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            éŠæˆ²å¤§å¸«æ­£åœ¨ç”Ÿæˆä¸–ç•Œçš„å›é¥‹...
        </div>
    </div>

    <script>
        // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let apiKey = '';
        let apiType = 'gemini'; 
        let userId = 'user-' + crypto.randomUUID(); 
        let currentStage = 'api-key';
        let isChatActive = false;
        const BACKEND_URL = 'http://localhost:3000/api/simulate';
        
        let worldContext = {
            player_bio: '',
            current_goal: '',
            world_events: 'éŠæˆ²é–‹å§‹ï¼Œä¸€åˆ‡å°šæœªç™¼ç”Ÿã€‚',
            time_remaining_sec: undefined, 
        };

        // --- DOM å…ƒç´ å¿«å– ---
        const stageApiKey = document.getElementById('stage-api-key');
        const stageCreateChar = document.getElementById('stage-create-char');
        const stageGame = document.getElementById('stage-game');
        
        const apiTypeSelect = document.getElementById('api-type-select');
        const apiKeyInput = document.getElementById('api-key-input');
        const playerNameInput = document.getElementById('player-name-input');
        const playerBioInput = document.getElementById('player-bio-input');
        const playerGoalInput = document.getElementById('player-goal-input');

        const chatInterface = document.getElementById('chat-interface');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageBox = document.getElementById('message-box');
        
        const contextBio = document.getElementById('context-bio');
        const contextGoal = document.getElementById('context-goal');
        const contextEvents = document.getElementById('context-events');
        
        const gameOverOverlay = document.getElementById('game-over-overlay');
        const gameOverMessage = document.getElementById('game-over-message');
        const timeDisplay = document.getElementById('time-display');


        function setStage(stage) {
            stageApiKey.classList.add('hidden');
            stageCreateChar.classList.add('hidden');
            stageGame.classList.add('hidden');
            
            switch (stage) {
                case 'api-key':
                    stageApiKey.classList.remove('hidden');
                    break;
                case 'create-char':
                    stageCreateChar.classList.remove('hidden');
                    break;
                case 'game':
                    stageGame.classList.remove('hidden');
                    stageGame.classList.add('flex');
                    isChatActive = true;
                    updateContextPanel(worldContext);
                    break;
            }
            currentStage = stage;
            hideMessage();
        }
        
        // æ›´æ–°æ™‚é–“é¡¯ç¤ºé‚è¼¯
        function updateTimeDisplay(remainingSec) {
            const minutes = Math.floor(remainingSec / 60);
            const seconds = remainingSec % 60;
            const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timeDisplay.textContent = timeStr;
            
            // è¦–è¦ºè­¦å‘Š
            if (remainingSec <= 60 && remainingSec > 0) {
                timeDisplay.parentNode.classList.add('text-red-600', 'animate-pulse');
            } else {
                timeDisplay.parentNode.classList.remove('text-red-600', 'animate-pulse');
            }
        }


        function updateContextPanel(context) {
            contextBio.textContent = context.player_bio;
            contextGoal.textContent = context.current_goal;
            contextEvents.textContent = context.world_events;
            worldContext = context;
        }

        function handleApiKeyInput() {
            const key = apiKeyInput.value.trim();
            const type = apiTypeSelect.value;

            if (key.length < 30) {
                showMessage('API Key ä¼¼ä¹å¤ªçŸ­äº†ï¼Œè«‹æª¢æŸ¥æ‚¨çš„é‡‘é‘°ã€‚', true);
                return;
            }
            
            apiKey = key;
            apiType = type;
            setStage('create-char');
        }

        function handleCharCreation() {
            const name = playerNameInput.value.trim();
            const bio = playerBioInput.value.trim();
            const goal = playerGoalInput.value.trim();

            if (!name || !bio || !goal) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰è§’è‰²è³‡è¨Šæ‰èƒ½é–‹å§‹éŠæˆ²ï¼', true);
                return;
            }

            worldContext.player_bio = `è§’è‰²åç¨±: ${name}ã€‚\n${bio}`;
            worldContext.current_goal = goal;
            worldContext.world_events = 'éŠæˆ²é–‹å§‹ï¼Œä¸–ç•Œç­‰å¾…è‘—ä½ çš„è¡Œå‹•ã€‚';
            
            setStage('game');
            
            // é¦–æ¬¡å‘å¾Œç«¯ç™¼é€åˆå§‹åŒ–è«‹æ±‚
            sendToBackend('INIT_CONTEXT', true);
        }

        function appendMessage(text, sender) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');
            bubble.style.whiteSpace = 'pre-wrap';
            bubble.textContent = text;
            chatInterface.appendChild(bubble);
            
            chatInterface.scrollTop = chatInterface.scrollHeight;
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (!message || !isChatActive) return;

            appendMessage(message, 'user');
            userInput.value = ''; 
            
            sendToBackend(message, false);
        }

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
        });

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'text-green-600', 'text-red-500');
            messageBox.classList.add(isError ? 'text-red-500' : 'text-green-600');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
            sendBtn.disabled = show;
            userInput.disabled = show;
        }

        // --- é€šè¨Šèˆ‡ç‹€æ…‹æ›´æ–° ---

        async function sendToBackend(message, isInitial) {
            showLoading(true);
            hideMessage();

            const payload = {
                apiKey: apiKey,
                apiType: apiType,
                userId: userId,
                worldContext: worldContext, 
                message: message,
            };

            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `å¾Œç«¯å›å‚³éŒ¯èª¤ (Status: ${response.status})`);
                }

                const data = await response.json();
                const jsonReply = data.reply; 
                
                if (isInitial) {
                    appendMessage(`éŠæˆ²é–‹å§‹ï¼${worldContext.player_bio.split('\n')[0]} æ­£åœ¨ä¸€å€‹å……æ»¿ç„¡é™å¯èƒ½çš„ç•°ä¸–ç•Œä¸­ã€‚ä½ çš„ç¬¬ä¸€å€‹è¡Œå‹•æ˜¯ä»€éº¼ï¼Ÿ`, 'ai');
                } else {
                    // ä½¿ç”¨ JSON ä¸­çš„ narrative å­—æ®µä½œç‚ºæ•…äº‹æ–‡æœ¬
                    appendMessage(jsonReply.narrative || "[AI æ•˜äº‹éŒ¯èª¤: ç¼ºå°‘ narrative å­—æ®µ]", 'ai');
                }
                
                // *** æª¢æŸ¥çµæ§‹åŒ–æˆå°±æ¨™èªŒ ***
                if (jsonReply.achievement_unlocked === true) {
                    showMessage('ğŸ† æ­å–œï¼ä½ å®Œæˆäº†éŠæˆ²çš„ä¸€å€‹é‡å¤§éšæ®µæˆ–æ ¸å¿ƒç›®æ¨™ï¼', false);
                }

                // *** æª¢æŸ¥ Game Over ç‹€æ…‹ ***
                if (jsonReply.game_state_change && jsonReply.game_state_change.game_over === true) {
                    isChatActive = false;
                    userInput.disabled = true;
                    sendBtn.disabled = true;
                    
                    gameOverMessage.textContent = jsonReply.game_state_change.critical_message || "ä¸–ç•Œæ¨¡æ“¬çµ‚çµã€‚";
                    gameOverOverlay.classList.remove('hidden');
                    
                    // ç¢ºä¿æ™‚é–“é¡¯ç¤ºä¹Ÿåœæ­¢
                    updateTimeDisplay(0); 
                    
                    showMessage('éŠæˆ²çµæŸã€‚è«‹é‡æ–°æ•´ç†é é¢é–‹å§‹æ–°çš„æ—…ç¨‹ã€‚', true);
                }


                // *** æ›´æ–°é•·æœŸè¨˜æ†¶é¡¯ç¤º and Time ***
                if (data.updatedContext) {
                    updateContextPanel(data.updatedContext);
                    
                    // æ›´æ–°æ™‚é–“é¡¯ç¤º
                    if (data.updatedContext.time_remaining_sec !== undefined) {
                         const remaining = data.updatedContext.time_remaining_sec;
                         updateTimeDisplay(remaining);
                    }
                }

            } catch (error) {
                console.error('API å‘¼å«å¤±æ•—:', error);
                if (error.message.includes("Failed to fetch")) {
                     showMessage('é€£ç·šéŒ¯èª¤ï¼šè«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨ (Node.js) ä»åœ¨åŸ·è¡Œä¸­ã€‚', true);
                } else {
                     showMessage(`é€šè¨Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–éŒ¯èª¤æ—¥èªŒã€‚éŒ¯èª¤: ${error.message}`, true);
                }
            } finally {
                showLoading(false);
            }
        }
        
        window.onload = function() {
            setStage(currentStage);
        };

    </script>
</body>
</html>